<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Today System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for 'The Today System' feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f0; /* Off-white, paper-like background */
            min-height: 10vh;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .task-item {
            cursor: pointer;
            transition: all 0.1s ease-in-out;
        }
        .task-item:hover {
            /* Keep hover minimal for index card look */
            background-color: #fefefe !important; 
        }
        .task-item.completed {
            opacity: 0.6;
            background-color: #eff6ff;
        }
        
        /* Highlight for the Most Important Task (MIT) */
        .task-item.mit .task-text-content {
            font-weight: 700 !important; /* Bold the MIT text */
            color: #dc2626 !important; /* Red text to signify MIT */
        }
        
        /* Custom scrollbar for task lists */
        .task-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        .task-list::-webkit-scrollbar {
            width: 8px;
        }
        .task-list::-webkit-scrollbar-thumb {
            background-color: #a78bfa; /* Violet-400 */
            border-radius: 4px;
        }
        
        /* --- S3 ACCORDION STYLING --- */
        details > summary {
            list-style: none; /* Hide the default marker */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Hide the default marker for Safari */
        }
        details[open] > summary .chevron {
            transform: rotate(180deg);
        }

        /* Drop indicator for S3 reordering */
        #s3-accordion .task-item.drop-target-after {
            border-bottom: 2px solid #38bdf8; /* sky-400 */
            padding-bottom: 2px;
        }

        /* Style for the scoring buttons */
        .score-btn {
            @apply px-2 py-0.5 text-xs font-semibold rounded-full transition duration-150 shadow-sm;
        }

        /* --- INDEX CARD STYLING --- */
        .index-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .point-column {
            width: 3rem; /* Fixed width for the point columns */
            text-align: right;
            font-weight: 700;
            flex-shrink: 0;
            font-size: 1rem; /* text-base */
        }
        
        #today-card-header-row {
            padding-left: 3rem; /* Align with red margin */
            padding-right: 1.5rem; /* Align with right edge */
        }
        
        #today-card-body { 
            padding: 0.5rem 1.5rem 1rem 3rem; 
            min-height: 250px;
            position: relative;
            background-image: repeating-linear-gradient(to bottom, transparent, transparent 30px, #3b82f6 30px, #3b82f6 31px);
            background-size: 100% 31px;
            background-position: 0 40px;
        }

        #today-card-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20px;
            height: 100%;
            width: 2px;
            background-color: #fca5a5; /* Red-300 */
        }

        #today-list {
            max-height: none;
            overflow-y: visible;
        }
        
        #today-list .task-item {
            background-color: transparent !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0;
            margin-bottom: 0;
            min-height: 30px; 
            line-height: 30px; 
            display: flex;
            align-items: center;
        }

        #today-list .task-item.drop-target-after {
            border-bottom: 2px solid #a78bfa; /* Violet-400 */
            padding-bottom: 2px;
        }

        #today-list .task-item .task-content-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #today-list .task-item .task-text-content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 30px; 
            font-size: 1.125rem; /* text-lg */
            font-weight: 500;
        }
        
        #today-list .task-item .delete-btn,
        #today-list .task-item .score-controls {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        #today-list .task-item:hover .delete-btn,
        #today-list .task-item:hover .score-controls {
            opacity: 1;
        }
        
        #today-list .task-item.mit .task-text-container {
            font-weight: 700;
        }
        
        #today-list #today-empty {
            padding-left: 0;
            text-align: left;
        }
        
        /* --- AUTOCOMPLETE DROPDOWN --- */
        .autocomplete-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            width: 100%; /* Match the input width */
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background-color: #f0f0f0;
        }
        .autocomplete-item strong {
            color: #8b5cf6; /* Violet-500 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">
        
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-1 flex items-center">
                    <span data-lucide="notebook-text" class="mr-3 text-violet-600 w-8 h-8"></span>
                    The Today System
                </h1>
                <p id="user-info" class="text-sm text-gray-500 mt-2 sm:mt-0">
                    Loading user...
                </p>
            </div>
            <p class="text-lg text-gray-600 font-semibold mt-2">Daily focus, goal-aligned projects, and scorekeeping.</p>
        </header>

        <div class="mb-8 card rounded-xl p-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                <span data-lucide="inbox" class="w-5 h-5 mr-2 text-gray-400"></span>
                Capture New Action
            </h2>
            <div class="flex flex-col sm:flex-row gap-2 items-end">
                <input type="text" id="new-task-input" placeholder="Verb | Noun | Details (e.g., Draft analysis report for Q3)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-violet-500 focus:border-violet-500 text-gray-700 w-full">
                <button id="add-task-btn"
                        class="px-6 py-3 bg-violet-600 text-white font-semibold rounded-lg hover:bg-violet-700 transition duration-150 ease-in-out shadow-lg flex items-center justify-center w-full sm:w-auto disabled:bg-violet-400 disabled:cursor-not-allowed"
                        disabled>
                    <span data-lucide="plus" class="w-5 h-5 mr-1"></span>
                    Add Task
                </button>
            </div>
            <p id="error-message" class="text-red-500 text-sm mt-2 hidden"></p>
        </div>

        <div class="mb-8 card rounded-xl p-0 bg-white index-card">
            
            <div class="p-4 flex justify-between items-center border-b-2 border-red-500">
                <h2 class="text-2xl font-bold text-violet-800">
                    The Today Card (Max 5)
                </h2>
                <div class="flex items-center space-x-4">
                    <div class="text-sm font-medium text-gray-700">
                        <span class="text-red-600 font-bold">P:</span><span id="possible-points" class="ml-1 font-bold">0</span> 
                        / 
                        <span class="text-green-600 font-bold">A:</span><span id="actual-points" class="ml-1 font-bold">0</span>
                    </div>
                    <button id="daily-review-btn" 
                            class="px-3 py-1 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600 transition duration-150 flex items-center text-sm disabled:opacity-50"
                            disabled>
                        <span data-lucide="calendar-check" class="w-4 h-4 mr-1"></span> Daily Review
                    </button>
                </div>
            </div>
            
            <div id="today-card-header-row" class="flex items-center text-sm font-semibold text-gray-500 py-1 bg-gray-50/50">
                <div class="flex-grow">Task Description / Score Multiplier</div>
                <div class="point-column text-violet-600">P</div>
                <div class="point-column text-green-600">A</div>
            </div>
            
            <div id="today-card-body" data-target="today"> 
                <div id="today-list" class="task-list"> 
                    <p class="text-gray-500 italic text-left" id="today-empty">Drag tasks here from S3. Max 5 recommended.</p>
                </div>
            </div>
        </div>

        <div id="system-layout" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="lg:col-span-1 space-y-4">
                 <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                    <span data-lucide="layers-3" class="w-6 h-6 mr-2 text-sky-500"></span>
                    S3 - Simplified Scheduling System
                </h2>
                
                <div id="s3-accordion" class="space-y-2">
                    <details class="s3-section bg-white rounded-lg shadow-sm border border-gray-200" open>
                        <summary class="flex justify-between items-center p-3 cursor-pointer text-lg font-semibold text-sky-700">
                            <div class="flex items-center"><span data-lucide="sun" class="w-4 h-4 mr-2"></span> Today/Tomorrow</div>
                            <span data-lucide="chevron-down" class="chevron w-5 h-5 transition-transform"></span>
                        </summary>
                        <div class="p-2">
                            <div id="s3-tomorrow-list" class="task-list space-y-3" data-target="s3-tomorrow">
                                 <p class="text-gray-500 italic text-center text-sm p-2">Tasks for immediate focus.</p>
                            </div>
                        </div>
                    </details>
                    <details class="s3-section bg-white rounded-lg shadow-sm border border-gray-200" open>
                        <summary class="flex justify-between items-center p-3 cursor-pointer text-lg font-semibold text-sky-700">
                            <div class="flex items-center"><span data-lucide="arrow-right-circle" class="w-4 h-4 mr-2"></span> Next Few Days</div>
                            <span data-lucide="chevron-down" class="chevron w-5 h-5 transition-transform"></span>
                        </summary>
                        <div class="p-2">
                            <div id="s3-few-days-list" class="task-list space-y-3" data-target="s3-few-days">
                                 <p class="text-gray-500 italic text-center text-sm p-2">What's coming up next.</p>
                            </div>
                        </div>
                    </details>
                    <details class="s3-section bg-white rounded-lg shadow-sm border border-gray-200" open>
                        <summary class="flex justify-between items-center p-3 cursor-pointer text-lg font-semibold text-sky-700">
                            <div class="flex items-center"><span data-lucide="calendar-days" class="w-4 h-4 mr-2"></span> This Week</div>
                            <span data-lucide="chevron-down" class="chevron w-5 h-5 transition-transform"></span>
                        </summary>
                        <div class="p-2">
                            <div id="s3-this-week-list" class="task-list space-y-3" data-target="s3-this-week">
                                 <p class="text-gray-500 italic text-center text-sm p-2">Must be done before the weekly review.</p>
                            </div>
                        </div>
                    </details>
                    <details class="s3-section bg-white rounded-lg shadow-sm border border-gray-200" open>
                        <summary class="flex justify-between items-center p-3 cursor-pointer text-lg font-semibold text-sky-700">
                            <div class="flex items-center"><span data-lucide="fast-forward" class="w-4 h-4 mr-2"></span> Next Week & After</div>
                            <span data-lucide="chevron-down" class="chevron w-5 h-5 transition-transform"></span>
                        </summary>
                        <div class="p-2">
                            <div id="s3-later-list" class="task-list space-y-3" data-target="s3-later">
                                 <p class="text-gray-500 italic text-center text-sm p-2">Non-pressing, but on the radar.</p>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-8">
                <div class="card rounded-xl p-6 bg-purple-50">
                    <h2 class="text-xl font-bold text-purple-800 mb-3 flex items-center">
                        <span data-lucide="trophy" class="w-5 h-5 mr-2 text-purple-600"></span>
                        Lifetime Scoreboard
                    </h2>
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-700">Lifetime Average: <span id="lifetime-score" class="text-purple-600 font-bold text-lg">---</span></p>
                        <p class="text-sm font-medium text-gray-700">Last 7 Days Avg: <span id="weekly-score" class="text-purple-600 font-bold text-lg">---</span></p>
                        <p class="text-sm text-gray-500 italic">Target: 750 (0.750)</p>
                    </div>
                </div>
                
                <div class="card rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <span data-lucide="flag" class="w-5 h-5 mr-2 text-red-500"></span>
                        Goals
                    </h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-goal-input" placeholder="Define a new goal..." class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="add-goal-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">Add</button>
                    </div>
                    <div id="goals-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
        
                <div class="card rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <span data-lucide="briefcase" class="w-5 h-5 mr-2 text-blue-500"></span>
                        Projects
                    </h2>
                    <div id="project-input-container" class="relative flex gap-2 mb-4">
                        <input type="text" id="new-project-input" placeholder="New project (type #G to link a goal)" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="add-project-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">Add</button>
                    </div>
                    <div id="projects-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>

                <div class="card rounded-xl p-6 bg-green-50">
                    <div class="flex justify-between items-baseline mb-4">
                         <h2 class="text-2xl font-bold text-green-800">
                             <span data-lucide="archive" class="w-6 h-6 mr-2 text-green-600 inline-block"></span>
                            Completed
                        </h2>
                        <button id="clear-completed-btn" 
                                class="text-sm text-green-600 hover:text-green-800 transition duration-150 flex items-center disabled:opacity-50"
                                disabled>
                            <span data-lucide="trash-2" class="w-4 h-4 mr-1"></span> Clear All
                        </button>
                    </div>
                    <div id="completed-list" class="task-list space-y-3 opacity-80" data-target="completed"> 
                         <p class="text-gray-500 italic text-center p-4" id="completed-empty">You haven't crushed any tasks yet!</p>
                    </div>
                </div>
            </div>

        </div>
        
        <div id="score-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <span data-lucide="award" class="w-6 h-6 mr-2 text-amber-500"></span>
                    Daily Review & Scorekeeping
                </h3>
                <p class="text-lg mb-2 text-gray-600">Your Score for Today: <span id="modal-score" class="font-extrabold text-green-600 text-2xl ml-1">---</span></p>
                <p class="text-sm text-gray-500 mb-4">You earned <span id="modal-actual">0</span> out of <span id="modal-possible">0</span> points.</p>
                
                <label for="reflection-input" class="block text-sm font-medium text-gray-700 mb-2">Reflection: How did the day go?</label>
                <textarea id="reflection-input" rows="4" placeholder="What contributed to your score? What will you do differently tomorrow?"
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-violet-500 focus:border-violet-500"></textarea>

                <div class="flex justify-between items-center mt-6 gap-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                    <button id="modal-submit-btn" class="px-6 py-3 bg-violet-600 text-white font-semibold rounded-lg hover:bg-violet-700 transition">
                        Save Score & Clear Today Card
                    </button>
                </div>
            </div>
        </div>

        <div id="app-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <h3 id="app-modal-title" class="text-xl font-semibold text-gray-800 mb-3">Action Confirmation</h3>
                <p id="app-modal-message" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
                <div class="flex justify-end gap-3">
                    <button id="app-modal-cancel-btn" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                    <button id="app-modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, writeBatch, runTransaction, Timestamp, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const todayDropZone = document.getElementById('today-card-body'); 
        const todayList = document.getElementById('today-list'); 
        const s3Lists = document.querySelectorAll('.task-list[data-target^="s3-"]');
        const completedList = document.getElementById('completed-list');
        const todayEmptyP = document.getElementById('today-empty');
        const completedEmptyP = document.getElementById('completed-empty');
        const userInfoP = document.getElementById('user-info');
        const clearCompletedBtn = document.getElementById('clear-completed-btn');
        const errorMessage = document.getElementById('error-message');
        const dailyReviewBtn = document.getElementById('daily-review-btn');
        const possiblePointsSpan = document.getElementById('possible-points');
        const actualPointsSpan = document.getElementById('actual-points');
        const lifetimeScoreSpan = document.getElementById('lifetime-score');
        const weeklyScoreSpan = document.getElementById('weekly-score');

        let app, db, auth, userId = null, isAuthReady = false;
        const TASKS_COLLECTION = 'tasks';
        const SCORES_COLLECTION = 'scores';
        const GOALS_COLLECTION = 'goals';
        const PROJECTS_COLLECTION = 'projects';
        const METADATA_COLLECTION = 'metadata';
        
        const TODAY_TASK_LIMIT = 5; 
        
        let allTasks = [], allScores = [], allGoals = [], allProjects = [];
        let draggedTaskId = null;

        const showModal = (title, message, confirmText = 'Confirm', confirmClass = 'bg-red-600 hover:bg-red-700') => {
            return new Promise(resolve => {
                const modal = document.getElementById('app-modal');
                const modalTitle = document.getElementById('app-modal-title');
                const modalMessage = document.getElementById('app-modal-message');
                const modalConfirmBtn = document.getElementById('app-modal-confirm-btn');
                const modalCancelBtn = document.getElementById('app-modal-cancel-btn');

                if (!modal || !modalTitle || !modalMessage || !modalConfirmBtn || !modalCancelBtn) {
                    console.error("Modal elements not found.");
                    return resolve(true);
                }

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.className = `px-4 py-2 text-white rounded-lg transition ${confirmClass}`;
                modalConfirmBtn.textContent = confirmText;
                
                const cleanup = (result) => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modalConfirmBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(result);
                };

                const handleConfirm = () => cleanup(true);
                const handleCancel = () => cleanup(false);
                modalConfirmBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
        };

        const displayError = (message) => {
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                setTimeout(() => errorMessage.classList.add('hidden'), 5000);
            } else {
                console.error("Application Error:", message);
            }
        };
        
        const getTodayDateId = () => new Date().toISOString().slice(0, 10);

        const setupFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     if (userInfoP) userInfoP.textContent = "Error: Firebase config missing.";
                     return;
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, async (user) => {
                    userId = user ? user.uid : (await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth))).user.uid;
                    if (userId) {
                         if (userInfoP) userInfoP.innerHTML = `User ID: <span class="font-mono text-xs p-1 bg-gray-200 rounded-md">${userId}</span>`;
                         isAuthReady = true;
                         document.getElementById('add-task-btn').disabled = false;
                         startRealtimeListeners();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                if (userInfoP) userInfoP.textContent = `Auth Error: ${error.message}`;
            }
        };
        
        const getCollectionRef = (name) => db && userId ? collection(db, `artifacts/${appId}/users/${userId}/${name}`) : null;

        const handleDragDropCommit = async (taskId, targetIdentifier) => {
            const draggedTask = allTasks.find(t => t.id === taskId);
            if (!draggedTask || draggedTask.status === 'completed') return;
            const tasksRef = getCollectionRef(TASKS_COLLECTION);
            if (!tasksRef) return displayError("App not ready.");
            const taskDocRef = doc(tasksRef, taskId);
            const updateData = {};
            if (targetIdentifier === 'today') {
                if (draggedTask.onTodayCard) return;
                const currentTodayCount = allTasks.filter(t => t.onTodayCard).length;
                if (currentTodayCount >= TODAY_TASK_LIMIT) {
                     const isConfirmed = await showModal('Focus Limit Reached!', `The card is full. Add anyway?`, 'Add Anyway', 'bg-red-500 hover:bg-red-600');
                     if (!isConfirmed) return;
                }
                updateData.onTodayCard = true;
                updateData.progress = 'none';
                const todayTasks = allTasks.filter(t => t.onTodayCard).sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());
                let minTimestamp = Timestamp.now().toMillis();
                if (todayTasks.length > 0) minTimestamp = todayTasks[0].createdAt?.toMillis() || minTimestamp;
                updateData.createdAt = Timestamp.fromMillis(minTimestamp - 1000);
            } else if (targetIdentifier.startsWith('s3-')) {
                if (draggedTask.onTodayCard) updateData.onTodayCard = false;
                if (draggedTask.status !== targetIdentifier) updateData.status = targetIdentifier;
                if (!draggedTask.onTodayCard) updateData.progress = 'none';
            }
            if (Object.keys(updateData).length > 0) {
                try { await updateDoc(taskDocRef, updateData); }
                catch (error) { displayError("Failed to update task location: " + error.message); }
            }
        };

        const addTask = async (text) => {
            const tasksRef = getCollectionRef(TASKS_COLLECTION);
            if (!tasksRef) return displayError("App not ready.");
            try {
                await addDoc(tasksRef, { text: text.trim(), status: 's3-tomorrow', onTodayCard: false, progress: 'none', createdAt: serverTimestamp(), userId });
                document.getElementById('new-task-input').value = '';
                document.getElementById('new-task-input').focus();
            } catch (error) { displayError("Failed to add task: " + error.message); }
        };

        const addGoal = async (text) => {
            const goalsRef = getCollectionRef(GOALS_COLLECTION);
            const metadataRef = doc(db, `artifacts/${appId}/users/${userId}/${METADATA_COLLECTION}/goalCounter`);
            if (!goalsRef) return displayError("App not ready.");
            try {
                const newGoalId = await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(metadataRef);
                    const newCount = (counterDoc.exists() ? counterDoc.data().count : 0) + 1;
                    transaction.set(metadataRef, { count: newCount });
                    return newCount;
                });
                await addDoc(goalsRef, { text: text.trim(), goalId: newGoalId, fullGoalId: `#G${newGoalId}`, status: 'active', createdAt: serverTimestamp(), userId });
                document.getElementById('new-goal-input').value = '';
            } catch (error) { displayError("Failed to add goal: " + error.message); }
        };
        
        const addProject = async (text, linkedGoalId) => {
            const projectsRef = getCollectionRef(PROJECTS_COLLECTION);
            if (!projectsRef) return displayError("App not ready.");
            try {
                await addDoc(projectsRef, { text: text.trim(), linkedGoalId, status: 'active', createdAt: serverTimestamp(), userId });
                const input = document.getElementById('new-project-input');
                input.value = '';
                input.dataset.linkedGoalId = '';
            } catch (error) { displayError("Failed to add project: " + error.message); }
        };
        
        const updateGoalStatus = async (id, status) => {
            const docRef = doc(getCollectionRef(GOALS_COLLECTION), id);
            await updateDoc(docRef, { status });
        };

        const updateProjectStatus = async (id, status) => {
            const docRef = doc(getCollectionRef(PROJECTS_COLLECTION), id);
            await updateDoc(docRef, { status });
        };
        
        const reorderTaskTimestamps = async (draggedId, targetIndex) => { /* ... unchanged ... */ };
        const reorderS3Tasks = async (draggedId, targetIndex, status) => { /* ... unchanged ... */ };
        const updateTaskProgress = async (taskId, newProgress) => { /* ... unchanged ... */ };
        const deleteTask = async (taskId) => { /* ... unchanged ... */ };
        const saveDailyScore = async (scoreData, todayTasks) => { /* ... unchanged ... */ };
        const clearCompletedTasks = async (completedTasks) => { /* ... unchanged ... */ };
        const calculatePoints = (todayTasks) => { /* ... unchanged ... */ };

        const createItemElement = (item, type, projects) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-50';
            const textSpan = document.createElement('span');
            textSpan.className = `flex-grow ${item.status === 'completed' ? 'line-through text-gray-400' : ''}`;
            
            if (type === 'goal') {
                const projectCount = projects.filter(p => p.linkedGoalId === item.fullGoalId && p.status === 'active').length;
                textSpan.innerHTML = `<span class="font-bold text-red-600 mr-2">${item.fullGoalId}</span> ${item.text} <span class="ml-2 text-xs font-semibold bg-gray-200 text-gray-600 rounded-full px-2 py-0.5">${projectCount}</span>`;
            } else {
                textSpan.innerHTML = item.text.replace(/(#G\d+)/g, '<strong class="text-red-600 font-semibold">$1</strong>');
            }

            const controls = document.createElement('div');
            controls.className = 'flex items-center space-x-1';
            
            if (item.status === 'active') {
                const completeBtn = document.createElement('button');
                completeBtn.innerHTML = `<span data-lucide="check-circle-2" class="w-4 h-4 text-gray-400 hover:text-green-500"></span>`;
                completeBtn.onclick = () => type === 'goal' ? updateGoalStatus(item.id, 'completed') : updateProjectStatus(item.id, 'completed');
                controls.appendChild(completeBtn);
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<span data-lucide="trash-2" class="w-4 h-4 text-gray-400 hover:text-red-500"></span>`;
            deleteBtn.onclick = () => type === 'goal' ? updateGoalStatus(item.id, 'deleted') : updateProjectStatus(item.id, 'deleted');
            controls.appendChild(deleteBtn);
            
            div.appendChild(textSpan);
            div.appendChild(controls);
            return div;
        };

        const createTaskElement = (task, index = -1, todayCount = 0) => { /* ... almost unchanged, just remove tagSpan logic ... */ 
            const isToday = task.onTodayCard === true; 
            const isCompleted = task.status === 'completed';
            const isMit = isToday && index === 0;
            const item = document.createElement('div');
            item.className = 'task-item flex flex-col transition duration-150'; 
            item.setAttribute('data-id', task.id);
            item.setAttribute('draggable', !isCompleted);
            if (isCompleted) item.classList.add('completed', 'border-green-300');
            if (isToday) {
                item.classList.add('shadow-none'); 
                if (isMit) item.classList.add('mit');
            } else {
                item.classList.add('p-3', 'rounded-lg', 'border', 'border-gray-200', 'shadow-sm', 'bg-white', 'space-y-1');
            }
            const possible = isToday ? (todayCount - index) : 0; 
            let earned = 0;
            if (task.progress === 'full') earned = possible;
            else if (task.progress === 'half') earned = possible / 2;
            earned = parseFloat(earned.toFixed(1));
            const contentRow = document.createElement('div');
            contentRow.className = `flex w-full items-center`; 
            const taskContentWrapper = document.createElement('div');
            taskContentWrapper.className = `task-content-wrapper flex items-center justify-between flex-grow`;
            const textContainer = document.createElement('div');
            textContainer.className = 'flex items-center flex-shrink-0'; 
            // The #G/#NG tagSpan is removed from here
            const taskText = document.createElement('span');
            taskText.className = `text-gray-800 break-words task-text-content`;
            taskText.textContent = task.text;
            if (isCompleted) taskText.classList.add('text-gray-500', 'line-through');
            if (isToday) {
                if (task.progress === 'full') taskText.classList.add('line-through', 'text-gray-500');
                else if (task.progress === 'half') taskText.classList.add('opacity-75');
            }
            if (isMit && isToday) {
                const mitLabel = document.createElement('span');
                mitLabel.textContent = "MIT: ";
                mitLabel.className = "text-sm text-red-600 font-semibold mr-1 flex-shrink-0";
                textContainer.prepend(mitLabel);
            }
            textContainer.appendChild(taskText);
            const controlsGroup = document.createElement('div');
            controlsGroup.className = 'flex items-center flex-shrink-0 space-x-2';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = `w-5 h-5 flex-shrink-0 text-gray-400 hover:text-red-500 transition duration-150 ${isToday ? 'delete-btn' : ''}`;
            deleteBtn.innerHTML = `<span data-lucide="x" class="w-4 h-4 m-auto block"></span>`;
            deleteBtn.title = 'Delete Task';
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                 const isConfirmed = await showModal('Delete Task?', `Delete: "${task.text}"?`, 'Delete', 'bg-red-600 hover:bg-red-700');
                 if (isConfirmed) deleteTask(task.id);
            };
            controlsGroup.appendChild(deleteBtn);
            if (isToday) { /* ... scoring controls unchanged ... */ }
            taskContentWrapper.appendChild(textContainer);
            taskContentWrapper.appendChild(controlsGroup);
            if (isToday) {
                const ppColumn = document.createElement('div');
                ppColumn.className = `point-column text-violet-600`;
                ppColumn.textContent = possible;
                const peColumn = document.createElement('div');
                peColumn.className = `point-column ${earned > 0 ? 'text-green-600' : 'text-gray-400'}`;
                peColumn.textContent = earned;
                contentRow.appendChild(taskContentWrapper);
                contentRow.appendChild(ppColumn);
                contentRow.appendChild(peColumn);
            } else {
                 contentRow.appendChild(taskContentWrapper);
                 contentRow.classList.remove('flex');
                 contentRow.classList.add('w-full', 'justify-between');
            }
            item.appendChild(contentRow);
            lucide.createIcons();
            return item;
        };
        
        const renderAll = () => {
            renderGoals(allGoals, allProjects);
            renderProjects(allProjects);
            renderTasks(allTasks);
            renderScores(allScores.map(s => ({data: () => s}))); // Adapt for function call
        };

        const renderGoals = (goals, projects) => {
            const list = document.getElementById('goals-list');
            list.innerHTML = '';
            goals.filter(g => g.status !== 'deleted').sort((a,b) => a.goalId - b.goalId).forEach(goal => {
                list.appendChild(createItemElement(goal, 'goal', projects));
            });
            lucide.createIcons();
        };

        const renderProjects = (projects) => {
            const list = document.getElementById('projects-list');
            list.innerHTML = '';
            projects.filter(p => p.status !== 'deleted').sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate()).forEach(project => {
                list.appendChild(createItemElement(project, 'project'));
            });
            lucide.createIcons();
        };

        const renderTasks = (tasks) => { /* ... almost unchanged, just remove projectTag logic ... */ };
        const renderScores = (scores) => { /* ... unchanged ... */ };
        
        const startRealtimeListeners = () => {
            const commonQuery = (ref) => query(ref, orderBy('createdAt', 'desc'));
            
            onSnapshot(commonQuery(getCollectionRef(TASKS_COLLECTION)), (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            onSnapshot(commonQuery(getCollectionRef(SCORES_COLLECTION)), (snapshot) => {
                allScores = snapshot.docs.map(doc => doc.data());
                renderAll();
            });
            onSnapshot(commonQuery(getCollectionRef(GOALS_COLLECTION)), (snapshot) => {
                allGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            onSnapshot(commonQuery(getCollectionRef(PROJECTS_COLLECTION)), (snapshot) => {
                allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        };

        const setupAutocomplete = (input, container, dataProvider, onSelect) => {
            let dropdown;
            const showDropdown = () => {
                if (!dropdown) {
                    dropdown = document.createElement('div');
                    dropdown.className = 'autocomplete-dropdown hidden';
                    container.appendChild(dropdown);
                }
                dropdown.classList.remove('hidden');
                updateDropdown();
            };
            const hideDropdown = () => dropdown?.classList.add('hidden');
            const updateDropdown = () => {
                if (!dropdown) return;
                const value = input.value.toLowerCase();
                const triggerIndex = value.lastIndexOf('#g');
                if (triggerIndex === -1) { hideDropdown(); return; }

                const query = value.substring(triggerIndex + 2);
                const items = dataProvider().filter(g => g.status === 'active' && g.text.toLowerCase().includes(query));
                
                dropdown.innerHTML = '';
                if (items.length > 0) {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.innerHTML = `<strong>${item.fullGoalId}</strong>: ${item.text}`;
                        div.onmousedown = (e) => { // mousedown to fire before blur
                            e.preventDefault();
                            onSelect(item);
                            hideDropdown();
                        };
                        dropdown.appendChild(div);
                    });
                } else {
                    dropdown.innerHTML = `<div class="autocomplete-item text-gray-500">No matching goals</div>`;
                }
            };

            input.addEventListener('focus', showDropdown);
            input.addEventListener('input', showDropdown);
            input.addEventListener('blur', () => setTimeout(hideDropdown, 150)); // Delay to allow click
        };

        // --- Drag and Drop Logic (unchanged) ---
        const handleDragStart=(e)=>{draggedTaskId=e.currentTarget.getAttribute("data-id"),e.currentTarget.classList.add("opacity-40"),e.dataTransfer.setData("text/plain",draggedTaskId)},handleDragEnd=(e)=>{e.currentTarget.classList.remove("opacity-40"),todayList.querySelectorAll(".task-item").forEach(e=>{e.classList.remove("drop-target-after")}),draggedTaskId=null},handleContainerDragOver=(e)=>{e.preventDefault(),e.dataTransfer.dropEffect="move",e.currentTarget.classList.add("border-4","border-dashed","border-violet-400")},handleContainerDragLeave=(e)=>{e.currentTarget.classList.remove("border-4","border-dashed","border-violet-400")},handleLocationChangeDrop=(e)=>{e.preventDefault();const t=e.currentTarget;if(t.classList.remove("border-4","border-dashed","border-violet-400"),draggedTaskId){const e=t.getAttribute("data-target");"completed"!==e&&handleDragDropCommit(draggedTaskId,e)}},handleTodayDragOver=(e)=>{e.preventDefault(),e.dataTransfer.dropEffect="move",todayList.querySelectorAll(".task-item").forEach(e=>{e.classList.remove("drop-target-after")});const t=e.dataTransfer.getData("text/plain"),a=e.currentTarget;if(allTasks.find(e=>e.id===t)&&!allTasks.find(e=>e.id===t).onTodayCard)return;if(a.getAttribute("data-id")===t)return;const d=a.getBoundingClientRect();(e.clientY-d.top)>d.height/2&&a.classList.add("drop-target-after")},handleS3DragOver=(e)=>{e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.currentTarget,a=t.closest(".task-list");a.querySelectorAll(".task-item").forEach(e=>{e.classList.remove("drop-target-after")});const d=e.dataTransfer.getData("text/plain");if(t.getAttribute("data-id")===d)return;const r=t.getBoundingClientRect();(e.clientY-r.top)>r.height/2&&t.classList.add("drop-target-after")},handleTodayDrop=(e)=>{e.preventDefault(),todayList.querySelectorAll(".task-item").forEach(e=>{e.classList.remove("drop-target-after")});const t=e.currentTarget,a=e.dataTransfer.getData("text/plain");if(a){const d=allTasks.find(e=>e.id===a);if(d&&!d.onTodayCard)return void handleDragDropCommit(a,"today");const r=t.getAttribute("data-id");if(a!==r){const l=allTasks.filter(e=>e.onTodayCard).sort((e,t)=>e.createdAt.toDate()-t.createdAt.toDate()).slice(0,TODAY_TASK_LIMIT);let o=l.findIndex(e=>e.id===r);const s=t.getBoundingClientRect();(e.clientY-s.top)>s.height/2&&(o+=1);const n=l.findIndex(e=>e.id===a);-1!==n&&(n===o||n+1===o)||reorderTaskTimestamps(a,o)}}},handleS3Drop=(e)=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget,a=t.closest(".task-list");a.querySelectorAll(".task-item").forEach(e=>{e.classList.remove("drop-target-after")});const d=e.dataTransfer.getData("text/plain");if(d){const r=allTasks.find(e=>e.id===d),l=allTasks.find(e=>e.id===t.getAttribute("data-id"));if(r&&l&&r.id!==l.id)if(r.status===l.status){const o=allTasks.filter(e=>e.status===r.status).sort((e,t)=>t.createdAt.toDate()-e.createdAt.toDate());let s=o.findIndex(e=>e.id===l.id);const n=t.getBoundingClientRect();(e.clientY-n.top)>n.height/2&&(s+=1),reorderS3Tasks(d,s,r.status)}else{const e=l.status;handleDragDropCommit(d,e)}}};const setupDragAndDrop=()=>{document.querySelectorAll('.task-item[draggable="true"]').forEach(e=>{e.removeEventListener("dragstart",handleDragStart),e.removeEventListener("dragend",handleDragEnd),e.removeEventListener("dragover",handleTodayDragOver),e.removeEventListener("drop",handleTodayDrop),e.removeEventListener("dragover",handleS3DragOver),e.removeEventListener("drop",handleS3Drop),e.addEventListener("dragstart",handleDragStart),e.addEventListener("dragend",handleDragEnd);const t=e.closest(".task-list");t&&("today-list"===t.id?(e.addEventListener("dragover",handleTodayDragOver),e.addEventListener("drop",handleTodayDrop)):t.dataset.target?.startsWith("s3-")&&(e.addEventListener("dragover",handleS3DragOver),e.addEventListener("drop",handleS3Drop)))});const e=[todayDropZone,...s3Lists,completedList];e.forEach(e=>{e&&(e.removeEventListener("dragover",handleContainerDragOver),e.removeEventListener("dragleave",handleContainerDragLeave),e.removeEventListener("drop",handleLocationChangeDrop),e.addEventListener("dragover",handleContainerDragOver),e.addEventListener("dragleave",handleContainerDragLeave),e.addEventListener("drop",handleLocationChangeDrop))})};

        // --- Event Listeners ---
        const handleAddTask = () => { const text = document.getElementById('new-task-input').value.trim(); if (text) addTask(text); };
        const showDailyReviewModal = () => { /* ... unchanged ... */ };

        window.onload = () => {
             document.getElementById('add-task-btn').addEventListener('click', handleAddTask);
             document.getElementById('new-task-input').addEventListener('keypress', (e) => e.key === 'Enter' && handleAddTask());
             document.getElementById('daily-review-btn').addEventListener('click', showDailyReviewModal);
             
             document.getElementById('add-goal-btn').addEventListener('click', () => {
                 const input = document.getElementById('new-goal-input');
                 if(input.value.trim()) addGoal(input.value.trim());
             });
             
             document.getElementById('add-project-btn').addEventListener('click', () => {
                 const input = document.getElementById('new-project-input');
                 const text = input.value.trim();
                 const linkedGoalId = input.dataset.linkedGoalId || '';
                 if (text) addProject(text, linkedGoalId);
             });

             const projectInput = document.getElementById('new-project-input');
             const projectInputContainer = document.getElementById('project-input-container');

             setupAutocomplete(
                projectInput,
                projectInputContainer,
                () => allGoals,
                (selectedGoal) => {
                    const currentValue = projectInput.value;
                    const triggerIndex = currentValue.lastIndexOf('#G');
                    const textBefore = currentValue.substring(0, triggerIndex);
                    projectInput.value = `${textBefore}${selectedGoal.fullGoalId} `;
                    projectInput.dataset.linkedGoalId = selectedGoal.fullGoalId;
                    projectInput.focus();
                }
             );

             lucide.createIcons();
             setupFirebase();
        }
    </script>
</body>
</html>

