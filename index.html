<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TodaySystem - Supabase Edition</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.4/+esm"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2em; background: #f5f5fa; }
    .hidden { display: none; }
    .error { color: red; }
    .container { max-width: 600px; margin: 0 auto; }
    .entity-list { margin: 1em 0; }
    .entity-item { margin-bottom: 0.5em; background: #fff; border-radius: 4px; padding: 0.75em 1em; box-shadow: 0 1px 2px #e0e0ef; display: flex; justify-content: space-between; align-items: center; }
    .entity-item span { flex: 1 1 auto; }
    form { margin-bottom: 1em; }
    input[type="text"], input[type="email"], input[type="password"] {
      padding: 0.5em;
      border-radius: 4px;
      border: 1px solid #bbb;
      margin-right: 0.5em;
      margin-bottom: 0.3em;
    }
    button { padding: 0.5em 1em; border-radius: 4px; border: none; background: #7c3aed; color: #fff; font-weight: bold; cursor: pointer; }
    button.secondary { background: #bbb; color: #222; }
    button.danger { background: #ef4444; }
    h1, h2 { color: #5b21b6; }
    #logout-btn { float: right; background: #bbb; color: #222; margin-bottom: 2em; }
    #auth-section { margin-bottom: 2em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>TodaySystem (Supabase Edition)</h1>

    <div id="auth-section">
      <h2>Login / Register</h2>
      <form id="auth-form" autocomplete="off">
        <input type="email" id="auth-email" placeholder="Email" required>
        <input type="password" id="auth-password" placeholder="Password" required>
        <button type="submit" id="login-btn">Login</button>
        <button type="button" id="signup-btn" class="secondary">Sign Up</button>
      </form>
      <p id="auth-error" class="error"></p>
    </div>

    <div id="app-section" class="hidden">
      <button id="logout-btn">Logout</button>
      <div>
        <h2>Tasks</h2>
        <form id="task-form">
          <input type="text" id="task-text" placeholder="New Task" required>
          <button type="submit">Add</button>
        </form>
        <div id="tasks-list" class="entity-list"></div>
      </div>

      <div>
        <h2>Goals</h2>
        <form id="goal-form">
          <input type="text" id="goal-text" placeholder="New Goal" required>
          <button type="submit">Add</button>
        </form>
        <div id="goals-list" class="entity-list"></div>
      </div>

      <div>
        <h2>Projects</h2>
        <form id="project-form">
          <input type="text" id="project-text" placeholder="New Project" required>
          <button type="submit">Add</button>
        </form>
        <div id="projects-list" class="entity-list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Supabase config ---
    const SUPABASE_URL = "https://uyoqwfwfiyiyzduorrof.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5b3F3ZndmaXlpeXpkdW9ycm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjcxMDQsImV4cCI6MjA3NTgwMzEwNH0.qW8GdBtRZqpo_AOXpM6aZdVTTaS4glD4qkyT1IWBoug";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Auth UI ---
    const authSection = document.getElementById("auth-section");
    const appSection = document.getElementById("app-section");
    const authForm = document.getElementById("auth-form");
    const signupBtn = document.getElementById("signup-btn");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const authError = document.getElementById("auth-error");
    let currentUser = null;

    // Entities UI
    const taskForm = document.getElementById("task-form");
    const taskText = document.getElementById("task-text");
    const tasksList = document.getElementById("tasks-list");

    const goalForm = document.getElementById("goal-form");
    const goalText = document.getElementById("goal-text");
    const goalsList = document.getElementById("goals-list");

    const projectForm = document.getElementById("project-form");
    const projectText = document.getElementById("project-text");
    const projectsList = document.getElementById("projects-list");

    // --- Auth Logic ---
    async function handleLoginOrSignup(type) {
      authError.textContent = "";
      const email = document.getElementById("auth-email").value;
      const password = document.getElementById("auth-password").value;
      try {
        let data, error;
        if (type === "login") {
          ({ data, error } = await supabase.auth.signInWithPassword({ email, password }));
        } else {
          ({ data, error } = await supabase.auth.signUp({ email, password }));
          if (!error && data.user) {
            alert("Signup successful! Please check your email for a confirmation link before logging in.");
          }
        }
        if (error) throw error;
        if (data.user) {
          currentUser = data.user;
          showApp();
        }
      } catch (err) {
        authError.textContent = err.message;
      }
    }

    authForm.onsubmit = (e) => {
      e.preventDefault();
      handleLoginOrSignup("login");
    };
    signupBtn.onclick = (e) => {
      e.preventDefault();
      handleLoginOrSignup("signup");
    };
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      showAuth();
    };

    function showAuth() {
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
    }
    function showApp() {
      authSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      refreshAll();
    }

    // On load, check session
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session?.user) {
        currentUser = session.user;
        showApp();
      } else {
        showAuth();
      }
    });
    // Listen for login/logout in other tabs
    supabase.auth.onAuthStateChange((_event, session) => {
      if (session?.user) {
        currentUser = session.user;
        showApp();
      } else {
        currentUser = null;
        showAuth();
      }
    });

    // --- CRUD Helpers ---
    // TASKS
    async function addTask(text) {
      if (!currentUser) return;
      await supabase.from("tasks").insert({ user_id: currentUser.id, text, status: "active" });
      refreshTasks();
    }
    async function getTasks() {
      if (!currentUser) return [];
      const { data } = await supabase.from("tasks").select("*").eq("user_id", currentUser.id).order("created_at");
      return data || [];
    }
    async function deleteTask(id) {
      if (!currentUser) return;
      await supabase.from("tasks").delete().eq("id", id).eq("user_id", currentUser.id);
      refreshTasks();
    }
    // GOALS
    async function addGoal(text) {
      if (!currentUser) return;
      await supabase.from("goals").insert({ user_id: currentUser.id, text });
      refreshGoals();
    }
    async function getGoals() {
      if (!currentUser) return [];
      const { data } = await supabase.from("goals").select("*").eq("user_id", currentUser.id).order("created_at");
      return data || [];
    }
    async function deleteGoal(id) {
      if (!currentUser) return;
      await supabase.from("goals").delete().eq("id", id).eq("user_id", currentUser.id);
      refreshGoals();
    }
    // PROJECTS
    async function addProject(text) {
      if (!currentUser) return;
      await supabase.from("projects").insert({ user_id: currentUser.id, text });
      refreshProjects();
    }
    async function getProjects() {
      if (!currentUser) return [];
      const { data } = await supabase.from("projects").select("*").eq("user_id", currentUser.id).order("created_at");
      return data || [];
    }
    async function deleteProject(id) {
      if (!currentUser) return;
      await supabase.from("projects").delete().eq("id", id).eq("user_id", currentUser.id);
      refreshProjects();
    }

    // --- UI Rendering ---
    async function refreshTasks() {
      const items = await getTasks();
      tasksList.innerHTML = items.map(
        t => `<div class="entity-item"><span>${t.text}</span> <button class="danger" onclick="deleteTask('${t.id}')">Delete</button></div>`
      ).join("");
    }
    async function refreshGoals() {
      const items = await getGoals();
      goalsList.innerHTML = items.map(
        g => `<div class="entity-item"><span>${g.text}</span> <button class="danger" onclick="deleteGoal('${g.id}')">Delete</button></div>`
      ).join("");
    }
    async function refreshProjects() {
      const items = await getProjects();
      projectsList.innerHTML = items.map(
        p => `<div class="entity-item"><span>${p.text}</span> <button class="danger" onclick="deleteProject('${p.id}')">Delete</button></div>`
      ).join("");
    }
    function refreshAll() {
      refreshTasks();
      refreshGoals();
      refreshProjects();
    }

    // --- Form Actions ---
    window.deleteTask = deleteTask;
    window.deleteGoal = deleteGoal;
    window.deleteProject = deleteProject;

    taskForm.onsubmit = (e) => {
      e.preventDefault();
      addTask(taskText.value.trim());
      taskText.value = "";
    };
    goalForm.onsubmit = (e) => {
      e.preventDefault();
      addGoal(goalText.value.trim());
      goalText.value = "";
    };
    projectForm.onsubmit = (e) => {
      e.preventDefault();
      addProject(projectText.value.trim());
      projectText.value = "";
    };
  </script>
</body>
</html>
